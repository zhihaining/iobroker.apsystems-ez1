<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>APsystems EZ1 Settings</title>

    <script src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script src="../../lib/js/adapter-settings.js"></script>
    <script src="words.js"></script>

    <style>
        .device-row {
            border: 1px solid #aaa;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
        }
        .remove-btn {
            margin-left: 10px;
        }
    </style>
</head>

<body>
<h3>APsystems EZ1 Adapter Settings</h3>

<h4>Devices</h4>
<div id="devices-list"></div>
<button id="add-device">Add Device</button>

<hr>

<label>Poll Interval (sec):</label>
<input data-name="pollInterval" id="pollInterval" type="number"><br><br>

<label>HTTP Timeout (ms):</label>
<input data-name="httpTimeout" id="httpTimeout" type="number"><br><br>

<label>HTTP Retries:</label>
<input data-name="httpRetries" id="httpRetries" type="number"><br><br>

<label>Alert Email:</label>
<input data-name="alertEmail" id="alertEmail" type="text"><br><br>

<script>
function addDeviceRow(device, onChange) {
    const row = $(`
        <div class="device-row">
            <label>Name:</label>
            <input data-name="dev-name" type="text" class="dev-name" value="${device.name || ''}">
            <label>IP:</label>
            <input data-name="dev-ip" type="text" class="dev-ip" value="${device.ip || ''}">
            <button class="remove-btn">Remove</button>
        </div>
    `);

    row.find("input").on("change input", onChange);

    row.find(".remove-btn").click(() => {
        row.remove();
        onChange();
    });

    $("#devices-list").append(row);
}

load(function (settings, onChange) {

    // Bind change event to all inputs
    $("input").on("change input", () => onChange());

    // Load devices
    const devices = settings.devices || [];
    devices.forEach(dev => addDeviceRow(dev, onChange));

    $("#add-device").click(() => addDeviceRow({ name:"", ip:"" }, onChange));

    // Load general settings
    $("#pollInterval").val(settings.pollInterval || 30);
    $("#httpTimeout").val(settings.httpTimeout || 5000);
    $("#httpRetries").val(settings.httpRetries || 2);
    $("#alertEmail").val(settings.alertEmail || "");

    onChange(false);
});

save(function () {

    // Build devices array
    const devices = [];
    $("#devices-list .device-row").each(function () {
        const name = $(this).find(".dev-name").val().trim();
        const ip = $(this).find(".dev-ip").val().trim();
        if (name && ip) {
            devices.push({ name, ip });
        }
    });

    return {
        devices,
        pollInterval: Number($("#pollInterval").val()),
        httpTimeout: Number($("#httpTimeout").val()),
        httpRetries: Number($("#httpRetries").val()),
        alertEmail: $("#alertEmail").val(),
    };
});
</script>

</body>
</html>
